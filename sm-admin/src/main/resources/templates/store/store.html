<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{base}">

<head>
<title></title>
</head>


<span layout:fragment="breadcrumb" id="breadcrumb">
	<h2>
		<span class="breadcrumb-title" th:text="#{'menu.store'}" /> <small></small>
	</h2>
	<ol class="breadcrumb">
		<li><a href="#"><i class="fa fa-building"></i>&nbsp;<span
				th:text="#{'menu.home'}"></span></a></li>
		<li class="active"><span th:text="#{'menu.store'}"></span></li>
	</ol>
</span>

<!-- Main row -->
<span layout:fragment="page_content" id="page_content">

	<div class="box box-default">
		<div class="box-header with-border">
			<h3 class="box-title">
				<span th:text="#{'label.store.information'}"></span>
			</h3>
		</div>
		<!-- /.box-header -->
		<div class="box-body">
			<div class="row">
				<div class="col-md-6">
				
					<p>
					<i class="fa fa-building"></i> <span th:text="#{'label.store.metadata'}"></span>
					</p>

					<form role="form" id="store">
						<div class="box-body">
							<div class="form-group">
								<label for="storeName"><span
									th:text="#{'label.storename'}"></span></label> <input
									class="form-control" id="name" name="name">
							</div>
							<div class="form-group">
								<label for="code"><span th:text="#{'label.storecode'}"></span></label>
								<input class="form-control" id="code" name="code">
							</div>
							<div class="form-group">
								<label for="phone"><span th:text="#{'label.storephone'}"></span></label>
								<input class="form-control" id="phone" name="phone">
							</div>
							<div class="form-group">
								<label for="phone"><span
									th:text="#{'label.storeemailaddress'}"></span></label> <input
									type="email" class="form-control" id="email" name="email">
							</div>

							<th:block th:include="fragments/address.html :: address"></th:block>
							<th:block th:include="fragments/languages.html :: languages"></th:block>
							
							
							<div class="form-group">
								<label for="currency"><span
									th:text="#{'label.currency'}"></span></label> 
									<select class="form-control" id="currency" name="currency"></select>
							</div>
							
							<div class="checkbox">
								<label> <input type="checkbox" class="checkTrueFalse" name="currencyFormatNational" id="currencyFormatNational"><span
									th:text="#{'label.store.currency.format'}"></span>
								</label>
								<p class="help-block"><span
									th:text="#{'label.store.currency.format.help'}"></span></p>
							</div>
							
							<div class="form-group">
								<label for="weight"><span
									th:text="#{'label.store.weightunit'}"></span></label> 
									<select class="form-control" id="weight" name="weight"></select>
							</div>
							
							<div class="form-group">
								<label for="size"><span
									th:text="#{'label.store.sizeunits'}"></span></label> 
									<select class="form-control" id="dimension" name="dimension"></select>
							</div>
							
							<div class="form-group">
				                <label><span
									th:text="#{'label.store.inbusinesssince'}"></span></label>
				
				                <div class="input-group date">
				                  <div class="input-group-addon">
				                    <i class="fa fa-calendar"></i>
				                  </div>
				                  <input type="text" class="form-control pull-right" data-date-format="yyyy-mm-dd" name="inBusinessSince" id="inBusinessSince">
				                </div>
				                <!-- /.input group -->
				            </div>
							
							<div class="checkbox">
								<label> <input class="checkTrueFalse" type="checkbox" name="useCache" id="useCache"><span
									th:text="#{'label.store.useCache'}"></span>
								</label>
							</div>

						</div>
						<!-- /.box-body -->

						<div class="box-footer">
							<button type="submit" class="btn btn-primary">
								<span th:text="#{'button.label.submit'}">
							</button>
						</div>
					</form>
				</div>
			</div>
			<!-- /.row -->
		</div>
		<!-- /.box-body -->
		<!-- 		
			<div class="box-footer">
			footer text if required
		</div> 
		-->
	</div>


</span>
<!-- /.span (main span) -->

<!-- All actions in store to be defined here -->
<th:block layout:fragment="script">
	<!-- address component -->
	<script src="/js/address.js"></script>
	<script src="/js/languages.js"></script>
	<script type="text/javascript">
      $(document).ready(function(){
    	  
  	    	//Date picker
	  	    $('#inBusinessSince').datepicker({
	  	      autoclose: true
	  	    })
    	  
    	    if('READ' == '[[${action}]]') {

	    		showLoader();
				//fetch store
	      		var url = BACKEND + "/store/" + STORECODE + '?lang=' + LANGUAGE;
	
		    	$.ajax({
		    	    type:"get",
		    	    crossDomain: true,
		    	    cache: false,
		    	    url: url,
		    	    dataType: "json",
		    	    headers: {
		    	        "Authorization": "Bearer " + TOKEN
		    	    },
		    	    success: function(data){
		    	       hideLoader();	
		    	       log(JSON.stringify(data));
		    	       $("#name").val(data.name);
		    	       $("#code").val(data.code);
		    	       $('#code').attr('readonly', true);
		    	       $("#phone").val(data.phone);
		    	       $("#email").val(data.email);
		    	       $("#address_address").val(data.address.address);
		    	       $("#city").val(data.address.city);
		    	       $("#country").val(data.address.country);
		    	       zones( data.address.country, data.address.stateProvince );
		    	       $("#postalCode").val(data.address.postalCode);
		    	       $("#defaultLanguage").val(data.defaultLanguage);
		    	       for (var i=0; i<data.supportedLanguages.length; i++) {
		    	    	    $("input[value='" + data.supportedLanguages[i] + "'][type='checkbox']").prop("checked", true);
		    	    	}
		    	       $("#currency").val(data.currency);
		    	       if(data.currencyFormatNational) {
		    	    	   $("input[name='currencyFormatNational'][type='checkbox']").prop("checked", true);
		    	       }
		    	       if(data.useCache) {
		    	    	   $("input[name='useCache'][type='checkbox']").prop("checked", true);
		    	       }
		    	       $("#weight").val(data.weight);
		    	       $("#dimension").val(data.dimension);
		    	       if(data.inBusinessSince != null) {
		    	    	   $("#inBusinessSince").val(data.inBusinessSince);
		    	       } else {
		    	    	   $('#inBusinessSince').datepicker("setDate", new Date() );
		    	       }
		    	      

		    	    },
		    	    error: function(response,textStatus,errorThrown) {
		    	    	//TODO if 403 or 401 redirect to not authorized page
		    	    	hideLoader();
		    	    	log(textStatus);
		    	        log(response);
		    	    	var r = jQuery.parseJSON(response.responseText);
		    	    	log(r.message + "-" + textStatus + "-" + errorThrown);
		    	    	$('.alert-danger').html(r.message);
		    	    	$('.alert-danger').show();
		    	    }
		    	});
    	    }
      		
  	    	
  	    	//handle submit
  	    	$("#store").submit(function(event){
				event.preventDefault(); //prevent default action 
				var form_data = $(this).serializeJSON(); //Encode form elements for submission
				
				
				
				log('*****POST*****');
				log(form_data);
				
				var url = BACKEND + "/private/store"
				
		    	$.ajax({
		    	    type:"post",
		    	    crossDomain: true,
		    	    cache: false,
		    	    url: url,
		    	    dataType: "json",
		    	    contentType : 'application/json; charset=utf-8',
		    	    data:JSON.stringify(form_data),
		    	    headers: {
		    	        "Authorization": "Bearer " + TOKEN
		    	    },
		    	    success: function(data){
		    	    	log('!!!success');
		    	    },
		    	    error: function(response,textStatus,errorThrown) {
		    	    	log('---error---');
		    	    }
		    	});
				
				//$.post( post_url, form_data, function( response ) {
				  //$("#server-results").html( response );
				  //log(response);
				//});
			});
  	    	
  	    	$(".checkTrueFalse").change(function() {
  	    		var $input = $( this );
  	    		if($input.is(':checked')) {
  	    			log('Is checked');
  	              	$input.attr('value', 'true');
  	          	 } else {
  	          		log('Not checked');
  	          		$input.attr('value', 'false');
  	          	 }

  	    	});
  	    	
  	    	
  	    	
  	    	
      		//handle unique code
      		
      		
      		
      		//handle country change
    	    $('#country').on('change', function() {
    	    	  zones( this.value, null );
    	    });
      		

      		
      		currency();
      		weight();
      		size();
      		
      });
      
      //load country
      //set default country
      //load zones from default country
      //set default zone
      addressComponent.BACKEND = BACKEND;
      addressComponent.MODE = '[[${action}]]';
      addressComponent.LANGUAGE = LANGUAGE;
      address();//load address component
      
      languagesComponent.BACKEND = BACKEND;
      languagesComponent.MODE = '[[${action}]]';
      languagesComponent.LANGUAGE = LANGUAGE;
      languages();//load address component
      
	  //populate currency
      function currency() {
    	  
			showLoader();
			var url = "/admin/references/currency";
		    
			$.getJSON(url, function (data) {

				$('#currency').empty();
		        $.each(data, function (i, data) {      // bind the dropdown list using json result              
   		             $("#currency").append($("<option></option>").val(data.code).html(data.name)); 
		        });
		        hideLoader();
		    })

	  }
      
      //populate weight
      function weight() {
    	  
			showLoader();
			var url = "/admin/references/weights";
		    
			$.getJSON(url, function (data) {

				$('#weight').empty();
		        $.each(data, function (i, data) {      // bind the dropdown list using json result              
 		             $("#weight").append($("<option></option>").val(data.code).html(data.name)); 
		        });
		        hideLoader();
		    })

	  }
      
      //populate size
      function size() {
    	  
			showLoader();
			var url = "/admin/references/sizes";
		    
			$.getJSON(url, function (data) {

				$('#dimension').empty();
		        $.each(data, function (i, data) {      // bind the dropdown list using json result              
 		             $("#dimension").append($("<option></option>").val(data.code).html(data.name)); 
		        });
		        hideLoader();
		    })

	  }
      
      </script>



</th:block>